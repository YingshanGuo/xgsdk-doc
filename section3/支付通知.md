#西瓜SDK 支付通知接口
****
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font face="微软雅黑">此文档是西瓜SDK支付通知接口接入文档。介绍西瓜订单服务器通知游戏服务器订单状态接口以及游戏服务器如何去西瓜订单服务器查询订单状态。
西瓜订单服务器在订单状态改变时,会主动调用支付通知接口通知游戏服务器订单信息。
游戏服务器在接受到通知请求时,应同时调用充值验证接口向西瓜订单服务器查询订单信息是否正确。
如果只接入支付通知接口,将不能防止订单信息伪造。</font>
<font face="微软雅黑" color="FF0000">注意</font>：<font face="微软雅黑">支付通知接口为登录流程必接接口。</font>
  

<link rel="stylesheet" href="http://yandex.st/highlightjs/6.2/styles/googlecode.min.css">
<script src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
<script src="http://yandex.st/highlightjs/6.2/highlight.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript">
 $(document).ready(function(){
      $("h2,h3,h4,h5,h6").each(function(i,item){
        var tag = $(item).get(0).localName;
        $(item).attr("id","wow"+i);
        $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
        $(".newh2").css("margin-left",0);
        $(".newh3").css("margin-left",20);
        $(".newh4").css("margin-left",40);
        $(".newh5").css("margin-left",60);
        $(".newh6").css("margin-left",80);
      });
 });
</script>
<div id="category" style="display:none"></div>

##一、支付通知接口（通知游戏支付结果）

###1、功能

<table>
<tr>
<td width="100">发起方</td><td>XGSDK服务端</td>
</tr>
<tr>
<td>接收方</td><td>游戏服务器</td>
</tr>
<tr>
<td>接口类型</td><td>HTTP POST</td>
</tr>
<tr>
<td>字符集编码</td><td>UTF-8</td>
</tr>
<tr>
<td>安全机制</td><td>签名</td>
</tr>
<tr>
<td>请求地址</td><td>游戏侧提供</td>
</tr>
<tr>
<td>功能描述</td><td>当接收到渠道的支付结果回调信息后，XGSDK服务端会对订单支付信息进行确认，完成后，XGSDK服务端会将订单支付结果信息推送到游戏服务器提供的支付订单回调地址。</td>
</table>

###2、输入

**参数说明：**

<table>
<tr>
<td>参数</td><td width="50">必选</td><td>类型</td><td>说明</td>
</tr>
<tr>
<td>type</td><td>是</td><td>String</td><td>接口类型，固定为notify_game</td>
</tr>
<tr>
<td>ts</td><td>是</td><td>String</td><td>当前时间戳，秒级，如20150723150028对应2015/7/23 15:00:28</td>
</tr>
<tr>
<td>gameTradeNo</td><td>是</td><td>String</td><td>游戏侧订单号</td>
</tr>
<tr>
<td>orderId</td><td>是</td><td>String</td><td>订单号</td>
</tr>
<tr>
<td>sdkUid</td><td>是</td><td>String</td><td>用户唯一标识，游戏服务器请用此字段作为对用户的唯一标识</td>
</tr>
<tr>
<td>payStatus</td><td>是</td><td>String</td><td>订单支付状态<br/>
1 支付成功<br/>
2 支付失败</td>
</tr>
<tr>
<td>payTime</td><td>是</td><td>String</td><td>支付时间 yyyyMMddHHmmss</td>
</tr>
<tr>
<td>failedDesc</td><td>否</td><td>String</td><td>如果成功支付，则为空串</td>
</tr>
<tr>
<td>sdkAppid</td><td>是</td><td>String</td><td>XGSDK分配的游戏编号</td>
</tr>
<tr>
<td>channelId</td><td>是</td><td>String</td><td>渠道在XGSDK的唯一标识</td>
</tr>
<tr>
<td>appGoodsId</td><td>否</td><td>String</td><td>游戏内的商品ID</td>
</tr>
<tr>
<td>appGoodsName</td><td>否</td><td>String</td><td>游戏内的商品名称</td>
</tr>
<tr>
<td>appGoodsDesc</td><td>否</td><td>String</td><td>商品描述</td>
</tr>
<tr>
<td>appGoodsAmount</td><td>否</td><td>String</td><td>购买的商品的数量</td>
</tr>
<tr>
<td>totalPrice</td><td>是</td><td>String</td><td>支付金额：单位：元</td>
</tr>
<tr>
<td>originalPrice</td><td>否</td><td>String</td><td>购买的商品的原价，单位为元，最多两位小数，多余小数四舍五入</td>
</tr>
<tr>
<td>zoneId</td><td>否</td><td>String</td><td>游戏区编号</td>
</tr>
<tr>
<td>serverId</td><td>否</td><td>String</td><td>游戏服编号</td>
</tr>
<tr>
<td>roleId</td><td>否</td><td>String</td><td>角色编号</td>
</tr>
<tr>
<td>roleName</td><td>否</td><td>String</td><td>角色昵称</td>
</tr>
<tr>
<td>currencyName</td><td>否</td><td>String</td><td>货币单位</td>
</tr>
<tr>
<td>custom</td><td>否</td><td>String</td><td>游戏方自定义字段，在请求新订单的时候传到服务器，有的话就返回</td>
</tr>
<tr>
<td>deviceId</td><td>否</td><td>String</td><td>设备id</td>
</tr>
<tr>
<td>deviceBrand</td><td>否</td><td>String</td><td>设备提供商： 小米、华为、三星、苹果</td>
</tr>
<tr>
<td>deviceModel</td><td>否</td><td>String</td><td>设备型号：小米note、华为meta7 iphone 6 plus等</td>
</tr>
<tr>
<td>sign</td><td>是</td><td>String</td><td>签名，签名算法参见签名章节，使用游戏服务端密钥</td>
</tr>
</table>

###3、输入

返回结果为JSON格式的字符串，分别有如下几个字段：

<table>
<tr>
<td>参数</td><td>说明</td>
</tr>
<tr>
<td>code</td><td>返回码，参见错误码章节</td>
</tr>
<tr>
<td>msg</td><td>接口调用信息提示</td>
</tr>
</table>

###4、请求样例

**请求参数：**

<table>
<tr>
<td>appGoodsAmount</td><td>1</td>
</tr>
<tr>
<td>appGoodsId</td><td>product1</td>
</tr>
<tr>
<td>appGoodsName</td><td>60元宝</td>
</tr>
<tr>
<td>channelId</td><td>mi</td>
</tr>
<tr>
<td>currencyName</td><td>人民币</td>
</tr>
<tr>
<td>custom</td><td>222323417123491234</td>
</tr>
<tr>
<td>gameTradeNo</td><td>99887766</td>
</tr>
<tr>
<td>orderId</td><td>2984456</td>
</tr>
<tr>
<td>payStatus</td><td>1</td>
</tr>
<tr>
<td>payTime</td><td>20150723150028</td>
</tr>
<tr>
<td>roleId</td><td>224455</td>
</tr>
<tr>
<td>roleName</td><td>性感</td>
</tr>
<tr>
<td>sdkAppid</td><td>1024appid</td>
</tr>
<tr>
<td>sdkUid</td><td>30854</td>
</tr>
<tr>
<td>serverId</td><td>1</td>
</tr>
<tr>
<td>totalPrice</td><td>600</td>
</tr>
</table>

**当前时间戳ts:** 20150723150028

**游戏服务端密钥:** 123456

**则请求签名源串为:**

	appGoodsAmount=1&appGoodsId=product1&appGoodsName=60元宝&channelId=mi&currencyName=人民币&custom=222323417123491234&gameTradeNo=99887766&orderId=2984456&payStatus=1&payTime=20150723150028&roleId=224455&roleName=性感小苹果&sdkAppid=1024appid&sdkUid=30854&serverId=1&totalPrice=600&ts=20150723150028&type=notify_game123456

**请求签名为：** ef3ea3eee9876cbf7c19c56f45ed7c402abd669ede0472d44b1088471470c314

**请求样例：**

	http://172.63.55.62:18888/moon/pay?appGoodsAmount=1&appGoodsId=product1&appGoodsName=60元宝&channelId=mi&currencyName=人民币&custom=222323417123491234&gameTradeNo=99887766&orderId=2984456&payStatus=1&payTime=20150723150028&roleId=224455&roleName=性感小苹果&sdkAppid=1024appid&sdkUid=30854&serverId=1&sign=ef3ea3eee9876cbf7c19c56f45ed7c402abd669ede0472d44b1088471470c314&totalPrice=600&ts=20150723150028&type=notify_game

###5、返回值样例

	{
    "code": "0",
    "msg": "success"
	}


##二、充值验证接口（二次查询验证订单）

###2.1 功能

<table>
<tr>
<td>发起方</td><td>游戏服务器</td>
</tr>
<tr>
<td>接收方</td><td>XGSDK服务端</td>
</tr>
<tr>
<td>接口类型</td><td>HTTP POST</td>
</tr>
<tr>
<td>字符集编码</td><td>UTF-8</td>
</tr>
<tr>
<td>安全机制</td><td>签名</td>
</tr>
<tr>
<td>请求地址</td><td>http://pay.xgsdk.com:8180/pay/verify_order/{sdkAppid}</td>
</tr>
</table>

**其中sdkAppid是游戏在XGSDK的唯一标示，如西游伏魔是1024appid。**

**功能描述:**
用于游戏服务器验证收到的订单通知是否有效。

###2.2 输入

**参数说明：**

<table>
<tr>
<td width="70">参数名称</td><td width="40">必选</td><td>类型</td><td>说明</td>
</tr>
<tr>
<td>type</td><td>是</td><td>String</td><td>接口类型，固定为verify_order</td>
</tr>
<tr>
<td>orderId</td><td>是</td><td>String</td><td>订单编号</td>
</tr>
<tr>
<td>ts</td><td>是</td><td>String</td><td>当前时间戳，秒级，如20150723150028对应2015/7/23 15:00:28</td>
</tr>
<tr>
<td>sign</td><td>是</td><td>String</td><td>签名，签名算法参见签名章节，使用游戏服务端密钥</td>
</tr>
</table>

###2.3 输出

**返回结果为JSON格式的字符串，分别有如下几个字段：**

<table>
<tr>
<td>字段</td><td>说明</td>
</tr>
<tr>
<td>code</td><td>返回码，参见错误码章节</td>
</tr>
<tr>
<td>msg</td><td>接口调用信息提示</td>
</tr>
<tr>
<td>data</td><td>接口返回数据</td>
</tr>
</table>

**data字段具体说明：**

<table>
<tr>
<td>返回字段</td><td width="40">必选</td><td>类型</td><td>说明</td>
</tr>
<tr>
<td>gameTradeNo</td><td>否</td><td>String</td><td>游戏侧订单号</td>
</tr>
<tr>
<td>orderId</td><td>是</td><td>String</td><td>订单号</td>
</tr>
<tr>
<td>sdkUid</td><td>是</td><td>String</td><td>用户唯一标识，游戏服务器请用此字段作为对用户的唯一标识</td>
</tr>
<tr>
<td>payStatus</td><td>是</td><td>String</td><td>订单支付状态<br/>
1 支付成功<br/>
2 支付失败</td>
</tr>
<tr>
<td>payTime</td><td>是</td><td>String</td><td>支付时间 yyyyMMddHHmmss</td>
</tr>
<tr>
<td>failedDesc</td><td>否</td><td>String</td><td>如果成功支付，则为空串</td>
</tr>
<tr>
<td>sdkAppid</td><td>是</td><td>String</td><td>XGSDK分配的游戏编号</td>
</tr>
<tr>
<td>channelId</td><td>是</td><td>String</td><td>渠道在XGSDK的唯一标识</td>
</tr>
<tr>
<td>appGoodsId</td><td>否</td><td>String</td><td>游戏内的商品ID</td>
</tr>
<tr>
<td>appGoodsName</td><td>否</td><td>String</td><td>游戏内的商品名称</td>
</tr>
<tr>
<td>appGoodsDesc</td><td>否</td><td>String</td><td>商品描述</td>
</tr>
<tr>
<td>appGoodsAmount</td><td>否</td><td>String</td><td>购买的商品的数量</td>
</tr>
<tr>
<td>totalPrice</td><td>是</td><td>String</td><td>支付金额：单位：元</td>
</tr>
<tr>
<td>originalPrice</td><td>否</td><td>String</td><td>购买的商品的原价，单位为元，最多两位小数，多余小数四舍五入</td>
</tr>
<tr>
<td>zoneId</td><td>否</td><td>String</td><td>游戏区编号</td>
</tr>
<tr>
<td>serverId</td><td>否</td><td>String</td><td>游戏服编号</td>
</tr>
<tr>
<td>roleId</td><td>否</td><td>String</td><td>角色编号</td>
</tr>
<tr>
<td>roleName</td><td>否</td><td>String</td><td>角色昵称</td>
</tr>
<tr>
<td>currencyName</td><td>否</td><td>String</td><td>货币单位</td>
</tr>
<tr>
<td>custom</td><td>否</td><td>String</td><td>游戏方自定义字段，在请求新订单的时候传到服务器，有的话就返回</td>
</tr>
<tr>
<td>deviceId</td><td>否</td><td>String</td><td>设备id</td>
</tr>
<tr>
<td>deviceBrand</td><td>否</td><td>String</td><td>设备提供商： 小米、华为、三星、苹果</td>
</tr>
<tr>
<td>deviceModel</td><td>否</td><td>String</td><td>设备型号：小米note、华为meta7 iphone 6 plus等</td>
</tr>
</table>

###2.4 请求样例

**请求参数：** orderId:2984456

**当前时间戳ts:** 20150723150028

**游戏服务端密钥:** 123456

**则请求签名源串为：**<br/>
orderId=2984456&ts=20150723150028&type=verify_order123456

**请求样例：**

	http://pay.xgsdk.com:8180/pay/verify_order/1024appid?orderId=2984456&sign=493c1a3bc3a116ec6e4695342c6b10d072480b38e811270c20abad9f0df08712&ts=20150723150028&type=verify_order

###2.5 返回值样例

	{
	    "code": "0",
	    "msg": "success",
	    "data": {
	        "appGoodsAmount": "1",
	        "appGoodsId": "product1",
	        "appGoodsName": "60元宝",
	        "channelId": "mi",
	        "currencyName": "人民币",
	        "custom": "222323417123491234",
	        "gameTradeNo": "99887766",
	        "orderId": "2984456",
	        "payStatus": "1",
	        "payTime": "20150723150028",
	        "roleId": "224455",
	        "roleName": "性感小苹果",
	        "sdkAppid": "1024appid",
	        "sdkUid": "30854",
	        "serverId": "1",
	        "totalPrice": "600"
	    }

	}

##三、错误码

<table>
<tr>
<td>错误码</td><td>备注</td>
</tr>
<tr>
<td>0</td><td>成功</td>
</tr>
<tr>
<td>-1</td><td>签名失败</td>
</tr>
<tr>
<td>1</td><td>请求重发</td>
</tr>
<tr>
<td>2</td><td>重复订单</td>
</tr>
<tr>
<td>-2</td><td>sdkAppid不存在</td>
</tr>
<tr>
<td>-3</td><td>channelId不存在</td>
</tr>
<tr>
<td>-4</td><td>区服不存在</td>
</tr>
<tr>
<td>-5</td><td>账号不存在</td>
</tr>
<tr>
<td>-6</td><td>订单号不存在</td>
</tr>
<tr>
<td>-100</td><td>获取登录验证参数失败</td>
</tr>
<tr>
<td>-101</td><td>获取渠道参数失败</td>
</tr>
<tr>
<td>-102</td><td>连接渠道登陆验证接口失败</td>
</tr>
<tr>
<td>-103</td><td>渠道登陆验证结果失败</td>
</tr>
<tr>
<td>-200</td><td>商品不存在</td>
</tr>
<tr>
<td>-201</td><td>商品不一致</td>
</tr>
<tr>
<td>-202</td><td>金额不一致</td>
</tr>
<tr>
<td>-203</td><td>渠道验证订单失败</td>
</tr>
</table>


###文档版本说明
<table>
<tr>
<td>SDK版本</td><td>文档版本</td> <td>DK修改内容</td> <td>文档修改内容</td> <td>修改日期</td>
</tr>
<tr>
<td>2.0 </td><td>1.0</td> <td>初版</td> <td>初版</td> <td>2015.7.31</td>
</tr>
</table>
